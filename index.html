<html>
<head>
  <meta charset=utf-8 />
  <title>Esri Leaflet Quickstart</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <!-- Load Leaflet from CDN-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.0/dist/leaflet-src.js"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.0.4"></script>

  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:0; bottom:0; right:0; left:0; }
  </style>

</head>
<body>

<link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.1.4/dist/esri-leaflet-geocoder.css">
<script src="https://unpkg.com/esri-leaflet-geocoder@2.1.4"></script>

<div id="map"></div>

<script>
  var addressLatLngGlobal = new L.LatLng(38.05193514322206, -84.49135992595838);
  var map = L.map('map').setView(addressLatLngGlobal, 13);

  L.esri.basemapLayer("Topographic").addTo(map);

  var leaves = L.esri.dynamicMapLayer({
    url: "https://maps.lexingtonky.gov/lfucggis/rest/services/leafcollection/MapServer",
  }).addTo(map);

  var arcgisOnline = L.esri.Geocoding.arcgisOnlineProvider();

  var addressPointsProvider = L.esri.Geocoding.mapServiceProvider({
    label: 'States and Counties',
    url: 'http://maps.lexingtonky.gov/lfucggis/rest/services/addresses/MapServer',
    layers: [0],
    searchFields: ['ADDRESS'],
    formatSuggestion: function(feature) {
      return feature.properties['ADDRESS'];
    }
  });

  var searchControl = L.esri.Geocoding.geosearch({
    providers: [ addressPointsProvider ]
  }).addTo(map);

  // create an empty layer group to store the results and add it to the map
  var results = L.layerGroup().addTo(map);


  var displaySearchResults = function(data) {
    results.clearLayers();

    var addressLatLng = data.results[0].latlng;

    leaves.identify().on(map).at(addressLatLng).run(function(error, featureCollection){
      if (featureCollection.features.length > 0) {
        var dates = featureCollection.features[0].properties['Dates'];
        if (!dates || dates === 'Null') {
          dates = "Because this address does not receive city waste services, it does not receive city leaf collection. <p>Please visit <a href='https://lexingtonky.gov'>lexingtonky.gov</a> for details.<p>";
        } else {
          dates = dates + '<div><label>Sign up for notifications <input type="text"></label><input type="submit"></div>';
        }
        var popup = L.popup()
            .setLatLng(addressLatLng)
            .setContent(dates)
            .openOn(map);
        map.setView(addressLatLng, 18)
      }
    });
  }

  displaySearchResults({results:[{latlng: addressLatLngGlobal}]});

  searchControl.on("results", displaySearchResults);
</script>

</body>
</html>
